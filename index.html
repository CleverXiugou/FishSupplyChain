<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŸ é±¼ç±»æº¯æº - æ‹…ä¿äº¤æ˜“ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #0077be; --bg: #f4f9ff; --card: #fff; --text: #333; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; padding: 20px; background: var(--bg); max-width: 900px; margin: 0 auto; color: var(--text); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        
        .card { background: var(--card); padding: 25px; margin-bottom: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; color: #444; font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; outline: none; transition: border 0.3s; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,119,190,0.1); }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; font-size: 14px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button.buy-btn { background: #e91e63; }
        button.logistics-btn { background: #ff9800; }
        button.confirm-btn { background: #28a745; margin-top: 10px; } 
        button.withdraw-btn { background: #673ab7; color: #fff; }
        button.sm-btn { width: auto; padding: 6px 12px; font-size: 12px; }

        .balance-box { background: #e3f2fd; border-left: 5px solid #0077be; padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .balance-num { font-size: 1.4rem; font-weight: bold; color: #0077be; }

        .market-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: #f1f3f4; color: #555; border: 1px solid #eee; padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; width: auto; cursor:pointer;}
        .filter-btn.active { background: var(--primary); color: white; }

        /* æº¯æº Tab */
        .trace-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .trace-tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; }
        .trace-tab.active { border-color: var(--primary); color: var(--primary); font-weight: bold; }

        .scrollable-fish-container { max-height: 500px; overflow-y: auto; background: #fafbfd; border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; }
        .fish-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
        
        .fish-card { border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fff; cursor: pointer; transition: transform 0.2s; position: relative;}
        .fish-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .fish-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .fish-details p { margin: 4px 0; display: flex; justify-content: space-between; font-size: 13px; color: #555; }
        .fish-hash { font-size: 11px; color: #999; margin-top: 8px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-0 { background: #eee; color: #555; } 
        .badge-1 { background: #e3f2fd; color: #0277bd; } 
        .badge-2 { background: #fff3cd; color: #856404; } 
        .badge-3 { background: #d4edda; color: #155724; } 

        .timeline { list-style: none; padding: 0; margin-top: 15px; border-left: 2px solid #eee; margin-left: 10px; }
        .timeline-item { margin-bottom: 20px; padding-left: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: #ccc; border: 2px solid #fff; }
        .timeline-item.active::before { background: var(--primary); }
        .timeline-date { font-size: 12px; color: #999; }
        .timeline-content { background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 13px; border: 1px solid #eee; }

        #status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 25px; background: rgba(0,0,0,0.85); color: white; border-radius: 30px; display: none; z-index: 1000; backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <h1>âš“ é±¼ç±»æº¯æº - å…¨ç¨‹å†·é“¾ç‰ˆ</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="connectWallet()" style="width:auto">ğŸ¦Š è¿æ¥é’±åŒ…</button>
        <div id="walletAddress" style="margin-top:5px; font-family: monospace; color: #666;">ğŸ”´ æœªè¿æ¥</div>
    </div>

    <div class="card" id="balanceSection" style="display:none;">
        <h2>ğŸ’° èµ„é‡‘è´¦æˆ· <button class="sm-btn withdraw-btn" onclick="withdrawPayments()">ğŸ’¸ ä¸€é”®æç°</button></h2>
        <div class="balance-box">
            <div>
                <div style="font-size:12px; color:#555">åˆçº¦å†…æš‚å­˜é‡‘é¢:</div>
                <div class="balance-num" id="pendingBalance">0.00 ETH</div>
            </div>
        </div>
    </div>

    <div class="card" style="border: 2px solid #ff9800;">
        <h2>ğŸšš ç‰©æµæ›´æ–° (Transport Update)</h2>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
            <input id="logId" type="number" placeholder="ğŸ†” é±¼ ID">
            <input id="newLoc" placeholder="ğŸ“ å½“å‰ä½ç½®">
            <input id="newTemp" type="number" placeholder="ğŸŒ¡ï¸ å½“å‰æ¸©åº¦">
            <button class="logistics-btn" onclick="updateLogistics()">ğŸ“¦ æ›´æ–°çŠ¶æ€</button>
        </div>
    </div>

    <div class="card" style="border: 2px solid #e91e63;">
        <h2>ğŸª äº¤æ˜“å¸‚åœº <button class="sm-btn" onclick="loadMarketplace()">ğŸ”„ åˆ·æ–°</button></h2>
        <div class="market-controls">
            <input type="text" id="marketSearch" placeholder="ğŸ” æœç´¢å“ç§..." oninput="renderMarketList()" style="flex:2">
            <select id="marketSort" onchange="renderMarketList()" style="flex:1">
                <option value="newest">ğŸ•’ æœ€æ–°</option>
                <option value="price_asc">â¬‡ï¸ ä»·æ ¼ä½â†’é«˜</option>
                <option value="price_desc">â¬†ï¸ ä»·æ ¼é«˜â†’ä½</option>
            </select>
        </div>
        <div class="scrollable-fish-container">
            <div id="marketList" class="fish-list"><p style="padding:20px;text-align:center;color:#999">åŠ è½½ä¸­...</p></div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ£ æ¸”æ°‘ï¼šæ•æ (Mint)</h2>
        <div class="grid">
            <input id="species" placeholder="ğŸŸ å“ç§">
            <input id="loc" placeholder="ğŸ“ åˆå§‹åœ°ç‚¹">
            <input id="temp" type="number" placeholder="ğŸŒ¡ï¸ åˆå§‹æ¸©åº¦">
            <input id="weight" type="number" placeholder="âš–ï¸ é‡é‡">
        </div>
        <button onclick="catchFish()">ğŸŒŠ æ•æä¸Šé“¾</button>
    </div>

    <div class="card" style="border: 2px solid #e1f5fe;">
        <h2>ğŸ’ æˆ‘çš„é±¼ç¯“ <span style="font-size:14px;font-weight:normal;">(<span id="fishCount">0</span>)</span> <button class="sm-btn" onclick="loadMyFish()" style="float:right">ğŸ”„ åˆ·æ–°</button></h2>
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="filterFish('all')">ğŸ“š å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterFish('private')">ğŸ”’ ç§æœ‰</button>
            <button class="filter-btn" onclick="filterFish('selling')">ğŸ’° åœ¨å”®</button>
            <button class="filter-btn" onclick="filterFish('sold')">ğŸ“¦ å¾…æ”¶è´§</button>
        </div>
        <div class="scrollable-fish-container">
            <div id="myFishList" class="fish-list"><p style="padding:20px;text-align:center;color:#999">è¯·è¿æ¥é’±åŒ…...</p></div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° å–å®¶ï¼šä¸Šæ¶æ“ä½œ</h2>
        <div class="grid">
            <input id="sellId" type="number" placeholder="ğŸ†” é±¼ ID">
            <input id="sellPrice" type="number" placeholder="ğŸ’ å”®ä»· (ETH)">
        </div>
        <button onclick="listFish()">ğŸ·ï¸ æ”¯ä»˜æŠ¼é‡‘å¹¶ä¸Šæ¶</button>
    </div>

    <div class="card" style="border-top: 4px solid #28a745;">
        <h2>ğŸ” æº¯æºæŸ¥è¯¢ç³»ç»Ÿ</h2>
        
        <div class="trace-tabs">
            <div class="trace-tab active" onclick="switchTraceMode('full')" id="tabFull">ğŸ“œ å…¨æµç¨‹æº¯æº</div>
            <div class="trace-tab" onclick="switchTraceMode('time')" id="tabTime">â±ï¸ æŒ‰æ—¶é—´ç‚¹æŸ¥è¯¢</div>
        </div>

        <div id="traceFullInput" style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="queryId" type="number" placeholder="è¾“å…¥ ID æŸ¥è¯¢å…¨ç¨‹å†å²..." style="flex:1">
            <button onclick="getTraceInfo()" style="width:auto">ğŸ” è¿½æº¯å…¨æµç¨‹</button>
        </div>

        <div id="traceTimeInput" style="display:none; gap:10px; margin-bottom:15px;">
            <input id="queryIdTime" type="number" placeholder="è¾“å…¥ ID" style="width:100px;">
            <input id="queryTime" type="datetime-local" style="flex:1">
            <button onclick="getTraceByTime()" style="width:auto">ğŸ“ æŸ¥è¯¢é‚£ä¸€åˆ»çŠ¶æ€</button>
        </div>

        <div id="traceResult"></div>
    </div>

    <div id="status"></div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è¯·æ›¿æ¢ä¸ºæœ€æ–°éƒ¨ç½²åˆçº¦åœ°å€ âš ï¸âš ï¸âš ï¸
        const CONTRACT_ADDRESS = "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"; 

        const ABI = [
            "function catchFish(string, string, string, int256, uint256, string) public returns (uint256)",
            "function listFish(uint256 tokenId, uint256 price) public payable",
            "function buyFish(uint256 tokenId) public payable",
            "function confirmReceipt(uint256 tokenId) public",
            "function withdrawPayments() public",
            "function updateLogistics(uint256 tokenId, string _location, int256 _temperature) public",
            "function getFishStatusAtTime(uint256 tokenId, uint256 queryTimestamp) view returns (string, int256, uint256, bool)", // æ–°å¢
            "function pendingWithdrawals(address) view returns (uint256)",
            "function fishDetails(uint256) view returns (string, string, int256, uint256, uint, string, uint256, uint8, address, address)",
            "function getFishByOwner(address) view returns (uint256[], tuple(string, string, int256, uint256, uint, string, uint256, uint8, address, address)[])",
            "function getAllFishForSale() view returns (uint256[], tuple(string, string, int256, uint256, uint, string, uint256, uint8, address, address)[])",
            "function getFishHistory(uint256) view returns (tuple(uint256 timestamp, string location, int256 temperature)[])",
            "function ownerOf(uint256) view returns (address)",
            "event FishCaught(uint256 indexed tokenId, address indexed fisherman, string species)",
            "event FishListed(uint256 indexed tokenId, uint256 price, address seller)",
            "event FishSold(uint256 indexed tokenId, address buyer, uint256 price)",
            "event FishConfirmed(uint256 indexed tokenId, address buyer, address seller)"
        ];

        let provider, signer, contract;
        const STATE_TEXT = ["ç§æœ‰", "å‡ºå”®ä¸­", "å¾…æ”¶è´§", "å·²å®Œæˆ"];
        let cachedMyFish = []; 
        let cachedMarketFish = []; 
        let currentFilter = 'all';

        async function connectWallet() {
            if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                document.getElementById("walletAddress").innerText = await signer.getAddress();
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                document.getElementById("balanceSection").style.display = "block";
                showToast("âœ… é’±åŒ…è¿æ¥æˆåŠŸ");
                
                checkPendingBalance();
                loadMyFish();
                loadMarketplace();
            } catch (e) { alert(e.message); }
        }

        // --- ç‰©æµæ›´æ–° ---
        async function updateLogistics() {
            const id = v('logId');
            const loc = v('newLoc');
            const temp = v('newTemp');
            if(!id || !loc || !temp) return alert("è¯·å¡«å†™å®Œæ•´");
            try {
                showToast("æ­£åœ¨æ›´æ–°ç‰©æµ...");
                const tx = await contract.updateLogistics(id, loc, temp);
                await tx.wait();
                showToast("âœ… ç‰©æµä¿¡æ¯å·²æ›´æ–°");
                refreshAll();
            } catch(e) { alert(e.message); }
        }

        // --- æº¯æº UI åˆ‡æ¢ ---
        function switchTraceMode(mode) {
            document.getElementById('tabFull').className = mode === 'full' ? 'trace-tab active' : 'trace-tab';
            document.getElementById('tabTime').className = mode === 'time' ? 'trace-tab active' : 'trace-tab';
            document.getElementById('traceFullInput').style.display = mode === 'full' ? 'flex' : 'none';
            document.getElementById('traceTimeInput').style.display = mode === 'time' ? 'flex' : 'none';
            document.getElementById('traceResult').innerHTML = ""; // æ¸…ç©ºç»“æœ
        }

        // --- æº¯æºæ¨¡å¼ä¸€ï¼šå…¨æµç¨‹ ---
        async function getTraceInfo() {
            if (!contract) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            const id = document.getElementById("queryId").value;
            if(!id) return alert("è¯·è¾“å…¥ID");
            
            const div = document.getElementById("traceResult");
            div.innerHTML = "ğŸ” æŸ¥è¯¢å…¨ç½‘æ•°æ®...";

            try {
                const info = await contract.fishDetails(id);
                if (!info[0]) throw new Error("æœªæ‰¾åˆ°æ­¤ID");
                const owner = await contract.ownerOf(id);
                const history = await contract.getFishHistory(id);

                let historyHtml = `<div class="logistics-track"><h4>ğŸŒ¡ï¸ å…¨ç¨‹å†·é“¾è½¨è¿¹</h4>`;
                if(history.length === 0) historyHtml += `<p style="color:#999">æš‚æ— è®°å½•</p>`;
                else {
                    history.forEach(h => {
                        const date = new Date(Number(h.timestamp) * 1000).toLocaleString();
                        historyHtml += `
                            <div class="track-item">
                                <div class="track-time">${date}</div>
                                <div class="track-dot"></div>
                                <div class="track-info">åˆ°è¾¾ <b>${h.location}</b>ï¼Œæ¸©åº¦ <b>${h.temperature}Â°C</b></div>
                            </div>`;
                    });
                }
                historyHtml += `</div>`;

                div.innerHTML = `
                    <div style="background:#f0f8ff; padding:15px; border-radius:10px; margin-top:10px;">
                        <h3 style="margin:0 0 10px 0; color:#0077be;">${info[0]} (ID: ${id})</h3>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; font-size:13px;">
                            <div>ğŸ“ æœ€æ–°ä½ç½®: ${info[1]}</div>
                            <div>ğŸŒ¡ï¸ æœ€æ–°æ¸©åº¦: ${info[2]} Â°C</div>
                            <div>ğŸ‘¤ å½“å‰æŒæœ‰: ${shortAddr(owner)}</div>
                        </div>
                        <hr style="border-top:1px dashed #ccc; margin:15px 0;">
                        ${historyHtml}
                    </div>
                `;
            } catch (e) { console.error(e); div.innerHTML = "<p style='color:red'>âŒ æŸ¥è¯¢å¤±è´¥</p>"; }
        }

        // --- æº¯æºæ¨¡å¼äºŒï¼šæŒ‰æ—¶é—´ç‚¹æŸ¥è¯¢ ---
        async function getTraceByTime() {
            if (!contract) return alert("è¯·å…ˆè¿æ¥é’±åŒ…");
            const id = document.getElementById("queryIdTime").value;
            const timeStr = document.getElementById("queryTime").value;
            if(!id || !timeStr) return alert("è¯·è¾“å…¥IDå’Œæ—¶é—´");

            const timestamp = Math.floor(new Date(timeStr).getTime() / 1000);
            const div = document.getElementById("traceResult");
            div.innerHTML = "ğŸ” æ­£åœ¨å›æº¯æ—¶å…‰...";

            try {
                // è°ƒç”¨åˆçº¦æ–°æ¥å£
                const res = await contract.getFishStatusAtTime(id, timestamp);
                const location = res[0];
                const temp = res[1];
                const recordedTime = res[2];
                const found = res[3];

                if (!found) {
                    div.innerHTML = `<p style="color:red; text-align:center; margin-top:20px;">âŒ è¯¥æ—¶é—´ç‚¹ï¼ˆ${new Date(timestamp*1000).toLocaleString()}ï¼‰é±¼è¿˜æœªæ•æï¼</p>`;
                    return;
                }

                div.innerHTML = `
                    <div style="background:#fff3cd; padding:20px; border-radius:10px; margin-top:10px; border:1px solid #ffeeba; text-align:center;">
                        <h3 style="margin:0 0 10px 0; color:#856404;">ğŸ•°ï¸ æ—¶ç©ºå¿«ç…§</h3>
                        <p style="font-size:14px; color:#856404;">æŸ¥è¯¢æ—¶é—´: ${new Date(timestamp*1000).toLocaleString()}</p>
                        <hr style="border-top:1px dashed #e6dbb9; margin:15px 0;">
                        <div style="font-size:16px;">
                            <p>å½“æ—¶ä½ç½®: <b>${location}</b></p>
                            <p>å½“æ—¶æ¸©åº¦: <b>${temp} Â°C</b></p>
                            <p style="font-size:12px; color:#999; margin-top:10px;">(åŸºäº ${new Date(Number(recordedTime)*1000).toLocaleString()} çš„è®°å½•)</p>
                        </div>
                    </div>
                `;
            } catch(e) { console.error(e); div.innerHTML = "<p style='color:red'>æŸ¥è¯¢å‡ºé”™</p>"; }
        }

        // --- å¸‚åœºä¸é±¼ç¯“ (ä¿æŒä¸å˜) ---
        async function loadMarketplace() {
            if (!contract) return;
            const div = document.getElementById("marketList");
            div.innerHTML = "<p style='text-align:center;width:100%'>åŠ è½½ä¸­...</p>";
            try {
                const res = await contract.getAllFishForSale();
                const ids = res[0];
                const fishes = res[1];
                const myAddress = await signer.getAddress();
                cachedMarketFish = [];
                for (let i = 0; i < ids.length; i++) {
                    cachedMarketFish.push({
                        id: ids[i], data: fishes[i], species: fishes[i][0],
                        priceWei: fishes[i][6], seller: fishes[i][8],
                        isMine: fishes[i][8].toLowerCase() === myAddress.toLowerCase()
                    });
                }
                renderMarketList();
            } catch (e) { div.innerHTML = "<p>åŠ è½½å¤±è´¥</p>"; }
        }

        function renderMarketList() {
            const div = document.getElementById("marketList");
            div.innerHTML = "";
            const searchTerm = document.getElementById("marketSearch").value.toLowerCase();
            const sortType = document.getElementById("marketSort").value;
            let filtered = cachedMarketFish.filter(item => item.species.toLowerCase().includes(searchTerm));
            filtered.sort((a, b) => {
                if (sortType === 'price_asc') return a.priceWei < b.priceWei ? -1 : 1;
                else if (sortType === 'price_desc') return a.priceWei > b.priceWei ? -1 : 1;
                else return b.id < a.id ? -1 : 1;
            });
            if (filtered.length === 0) { div.innerHTML = "<p style='color:#999; text-align:center; grid-column:1/-1; padding:20px;'>æš‚æ— å•†å“</p>"; return; }
            filtered.forEach(item => {
                const { id, data: f, priceWei, isMine } = item;
                const priceEth = ethers.formatEther(priceWei);
                let btnHtml = isMine ? `<button disabled style="background:#ccc; cursor:not-allowed;">ğŸš« æ‚¨çš„å•†å“</button>` : `<button class="buy-btn" onclick="buyFish('${id}', '${priceEth}')">ğŸ›’ è´­ä¹°</button>`;
                const card = document.createElement("div");
                card.className = "fish-card";
                card.style.borderColor = "#e91e63";
                card.innerHTML = `
                    <div class="fish-header"><h3 style="margin:0; color:#e91e63;">ğŸŸ ${f[0]}</h3><span class="badge" style="background:#fce4ec; color:#c2185b">ğŸ”¥ ID: ${id}</span></div>
                    <div class="fish-details">
                        <p><span>ğŸ“ åœ°ç‚¹:</span> <b>${f[1]}</b></p>
                        <p><span>âš–ï¸ é‡é‡:</span> <b>${f[3]} g</b></p>
                        <p><span>ğŸŒ¡ï¸ æ¸©åº¦:</span> <b>${f[2]} Â°C</b></p>
                        <p><span>ğŸ‘¤ å–å®¶:</span> ${shortAddr(f[8])}</p>
                        <hr style="border-top:1px dashed #eee; margin:8px 0;">
                        <p><span>ğŸ’ å”®ä»·:</span> <b style="color:#e91e63; font-size:1.1em">${priceEth} ETH</b></p>
                    </div>
                    ${btnHtml}
                `;
                div.appendChild(card);
            });
        }

        async function loadMyFish() {
            if (!contract) return;
            const div = document.getElementById("myFishList");
            div.innerHTML = "<p style='text-align:center;width:100%'>åŠ è½½ä¸­...</p>";
            try {
                const addr = await signer.getAddress();
                const res = await contract.getFishByOwner(addr);
                const ids = res[0];
                const fishes = res[1];
                cachedMyFish = [];
                for(let i=0; i<ids.length; i++) cachedMyFish.push({ id: ids[i], data: fishes[i], state: Number(fishes[i][7]) });
                document.getElementById("fishCount").innerText = ids.length;
                renderFishList();
            } catch (e) { console.error(e); }
        }

        function filterFish(type) {
            currentFilter = type;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderFishList();
        }

        function renderFishList() {
            const div = document.getElementById("myFishList");
            div.innerHTML = "";
            const filtered = cachedMyFish.filter(item => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'private') return item.state === 0 || item.state === 3;
                if (currentFilter === 'selling') return item.state === 1;
                if (currentFilter === 'sold') return item.state === 2;
                return true;
            });
            if (filtered.length === 0) { div.innerHTML = "<p style='color:#999; text-align:center; grid-column:1/-1; padding:20px;'>æš‚æ— æ•°æ®</p>"; return; }
            filtered.forEach(item => {
                const {id, data: f, state} = item;
                const price = ethers.formatEther(f[6]);
                const date = new Date(Number(f[4]) * 1000).toLocaleString();
                let actionHtml = "";
                if (state === 2) actionHtml = `<button class="confirm-btn" onclick="event.stopPropagation(); confirmReceipt('${id}')">âœ… ç¡®è®¤æ”¶è´§ (è§£å†»æŠ¼é‡‘)</button>`;
                const card = document.createElement("div");
                card.className = "fish-card";
                card.innerHTML = `
                    <div class="fish-header"><h3 style="margin:0; color:#0077be;">ğŸŸ ${f[0]}</h3><span class="badge badge-${state}">${STATE_TEXT[state]}</span></div>
                    <div class="fish-details">
                        <p><span>ID:</span> <b>${id}</b></p>
                        <p><span>ğŸ“ åœ°ç‚¹:</span> <b>${f[1]}</b></p>
                        <p><span>ğŸŒ¡ï¸ æ¸©åº¦:</span> <b>${f[2]} Â°C</b></p>
                        <p><span>âš–ï¸ é‡é‡:</span> <b>${f[3]} g</b></p>
                        <p><span>ğŸ•’ æ—¶é—´:</span> ${date}</p>
                        <div class="fish-hash">ğŸ”— Hash: ${f[5]}</div>
                        <hr style="border-top:1px dashed #eee; margin:8px 0;">
                        <p><span>ğŸ’ ä»·æ ¼:</span> <b style="color:${state===0?'#999':'red'}">${state===0 ? 'æœªå®š' : price+' ETH'}</b></p>
                    </div>
                    ${actionHtml}
                `;
                card.onclick = () => { 
                    document.getElementById("sellId").value = id; 
                    document.getElementById("logId").value = id;
                };
                div.appendChild(card);
            });
        }

        // --- åŸºç¡€äº¤äº’ ---
        async function buyFish(id, priceEth) {
            try {
                if(!confirm(`ç¡®è®¤è´­ä¹° ID:${id} ?\n\nå”®ä»·: ${priceEth} ETH\næŠ¼é‡‘: ${priceEth} ETH\næ€»è®¡éœ€ä»˜: ${priceEth*2} ETH`)) return;
                showToast("æ­£åœ¨æ”¯ä»˜...");
                const priceWei = ethers.parseEther(priceEth);
                const tx = await contract.buyFish(id, { value: priceWei * 2n });
                await tx.wait();
                showToast("âœ… è´­ä¹°æˆåŠŸï¼");
                refreshAll();
            } catch (e) { alert(e.message); }
        }

        async function catchFish() {
            const s=v("species"), l=v("loc"), t=v("temp"), w=v("weight");
            if(!s||!l||!t||!w) return alert("è¯·å¡«å†™å®Œæ•´");
            try {
                showToast("ä¸Šé“¾ä¸­...");
                const tx = await contract.catchFish("ipfs://demo", s, l, t, w, "HASH_"+Date.now());
                await tx.wait();
                showToast("âœ… æ•ææˆåŠŸ");
                refreshAll();
            } catch(e) { alert(e.message); }
        }

        async function listFish() {
            const id=v("sellId"), price=v("sellPrice");
            if(!id||!price) return alert("è¾“å…¥å®Œæ•´");
            try {
                const wei = ethers.parseEther(price);
                showToast("éœ€æ”¯ä»˜æŠ¼é‡‘...");
                const tx = await contract.listFish(id, wei, {value: wei});
                await tx.wait();
                showToast("âœ… ä¸Šæ¶æˆåŠŸ");
                refreshAll();
            } catch(e) { alert(e.message); }
        }

        async function confirmReceipt(id) {
            try {
                showToast("ç¡®è®¤æ”¶è´§...");
                const tx = await contract.confirmReceipt(id);
                await tx.wait();
                alert("âœ… äº¤æ˜“å®Œæˆï¼èµ„é‡‘å·²è§£å†»ã€‚");
                refreshAll();
            } catch(e) { alert(e.message); }
        }

        async function withdrawPayments() {
            try {
                showToast("æç°ä¸­...");
                const tx = await contract.withdrawPayments();
                await tx.wait();
                alert("âœ… æç°æˆåŠŸ");
                checkPendingBalance();
            } catch(e) { alert(e.message); }
        }

        function v(id) { return document.getElementById(id).value; }
        function shortAddr(addr) { return addr ? addr.slice(0,6)+"..."+addr.slice(-4) : ""; }
        function refreshAll() { clearInputs(); checkPendingBalance(); loadMyFish(); loadMarketplace(); }
        function clearInputs() { document.querySelectorAll("input").forEach(i => i.value = ""); }
        function showToast(msg) {
            const el = document.getElementById("status");
            el.innerText = msg;
            el.style.display = "block";
            setTimeout(() => el.style.display = "none", 3000);
        }
        async function checkPendingBalance() {
            if (!contract) return;
            try {
                const addr = await signer.getAddress();
                const bal = await contract.pendingWithdrawals(addr);
                document.getElementById("pendingBalance").innerText = ethers.formatEther(bal) + " ETH";
            } catch (e) {}
        }
    </script>
</body>
</html>