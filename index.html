<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸŸ é±¼ç±»æº¯æº - é±¼å¸ç”Ÿæ€ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.13.2/ethers.umd.min.js"></script>
    <style>
        :root { --primary: #0077be; --bg: #f4f9ff; --card: #fff; --text: #333; --coin: #f57f17; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; padding: 20px; background: var(--bg); max-width: 900px; margin: 0 auto; color: var(--text); }
        h1 { color: var(--primary); text-align: center; margin-bottom: 20px; }
        
        .card { background: var(--card); padding: 25px; margin-bottom: 20px; border-radius: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 10px; margin-top: 0; color: #444; font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 15px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; outline: none; transition: border 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,119,190,0.1); }
        
        button { background: var(--primary); color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; font-size: 14px; transition: opacity 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        button.buy-btn { background: #e91e63; }
        button.logistics-btn { background: #ff9800; }
        button.confirm-btn { background: #28a745; margin-top: 5px; } 
        button.reject-btn { background: #d32f2f; margin-top: 5px; }
        button.withdraw-btn { background: #673ab7; color: #fff; }
        button.approve-btn { background: #ffca28; color: #333; } /* æˆæƒæŒ‰é’® */
        button.sm-btn { width: auto; padding: 6px 12px; font-size: 12px; }

        /* é±¼å¸é“¶è¡Œæ ·å¼ */
        .token-card { border: 2px solid var(--coin); background: #fffde7; }
        .token-balance { font-size: 24px; font-weight: bold; color: var(--coin); }
        .rate-info { font-size: 12px; color: #777; margin-top: 5px; }

        .balance-box { background: #e3f2fd; border-left: 5px solid #0077be; padding: 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; }
        .balance-num { font-size: 1.4rem; font-weight: bold; color: #0077be; }

        .market-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; }
        .filter-tabs { display: flex; gap: 10px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { background: #f1f3f4; color: #555; border: 1px solid #eee; padding: 8px 16px; border-radius: 20px; font-size: 13px; white-space: nowrap; width: auto; cursor:pointer;}
        .filter-btn.active { background: var(--primary); color: white; }

        /* åˆ—è¡¨ä¸å¡ç‰‡ */
        .scrollable-fish-container { max-height: 500px; overflow-y: auto; background: #fafbfd; border: 1px solid #e1e4e8; border-radius: 12px; padding: 15px; }
        .fish-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 15px; }
        .fish-card { border: 1px solid #eee; padding: 15px; border-radius: 12px; background: #fff; cursor: pointer; transition: transform 0.2s; position: relative;}
        .fish-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
        .fish-header { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .fish-details p { margin: 4px 0; display: flex; justify-content: space-between; font-size: 13px; color: #555; }
        
        .badge { padding: 3px 8px; border-radius: 20px; font-size: 11px; font-weight: bold; }
        .badge-0 { background: #eee; color: #555; } 
        .badge-1 { background: #e3f2fd; color: #0277bd; } 
        .badge-2 { background: #fff3cd; color: #856404; } 
        .badge-3 { background: #d4edda; color: #155724; } 
        .badge-4 { background: #e57373; color: #b71c1c; }
        .spoiled-alert { background: #ffebee; color: #c62828; padding: 5px; font-size: 12px; text-align: center; border-radius: 4px; margin-top: 5px; border: 1px solid #ffcdd2; font-weight: bold; }

        /* æº¯æºç›¸å…³ */
        .trace-tabs { display: flex; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .trace-tab { padding: 10px 20px; cursor: pointer; border-bottom: 2px solid transparent; color: #666; }
        .trace-tab.active { border-color: var(--primary); color: var(--primary); font-weight: bold; }
        .timeline { list-style: none; padding: 0; margin-top: 15px; border-left: 2px solid #eee; margin-left: 10px; }
        .timeline-item { margin-bottom: 20px; padding-left: 20px; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -6px; top: 5px; width: 10px; height: 10px; border-radius: 50%; background: #ccc; border: 2px solid #fff; }
        .timeline-item.active::before { background: var(--primary); }
        .timeline-date { font-size: 12px; color: #999; }
        .timeline-content { background: #f9f9f9; padding: 10px; border-radius: 6px; margin-top: 5px; font-size: 13px; border: 1px solid #eee; }
        .snapshot-card { background:#fff3cd; padding:20px; border-radius:10px; margin-top:10px; border:1px solid #ffeeba; text-align:center; }

        #status { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); padding: 10px 25px; background: rgba(0,0,0,0.85); color: white; border-radius: 30px; display: none; z-index: 1000; backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <h1>âš“ é±¼ç±»æº¯æº - é±¼å¸ç”Ÿæ€ç‰ˆ</h1>
    
    <div style="text-align: center; margin-bottom: 20px;">
        <button onclick="connectWallet()" style="width:auto">ğŸ¦Š è¿æ¥é’±åŒ…</button>
        <div id="walletAddress" style="margin-top:5px; font-family: monospace; color: #666;">ğŸ”´ æœªè¿æ¥</div>
    </div>

    <div class="card token-card" id="bankSection" style="display:none;">
        <h2>ğŸ¦ é±¼å¸é“¶è¡Œ (FishCoin Bank)</h2>
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <div style="font-size:13px; color:#f9a825;">æˆ‘çš„ä½™é¢:</div>
                <div class="token-balance" id="myTokenBalance">0.0 FT</div>
            </div>
            <div style="text-align:right;">
                <input id="buyTokenAmount" type="number" placeholder="è¾“å…¥ ETH æ•°é‡" style="width:120px; padding:10px;">
                <button class="sm-btn" onclick="buyTokens()" style="background:#fbc02d; color:#333;">ğŸ’± ETH æ¢å¸</button>
                <div class="rate-info">å½“å‰æ±‡ç‡: 1 ETH = 10 FT</div>
            </div>
        </div>
    </div>

    <div class="card" id="balanceSection" style="display:none;">
        <h2>ğŸ’° äº¤æ˜“ç»“ç®—è´¦æˆ· <button class="sm-btn withdraw-btn" onclick="withdrawPayments()">ğŸ’¸ æå–é±¼å¸</button></h2>
        <div class="balance-box">
            <div>
                <div style="font-size:12px; color:#555">å¾…æç°é‡‘é¢:</div>
                <div class="balance-num" id="pendingBalance">0.0 FT</div>
            </div>
            <div style="font-size:12px; color:#666; max-width: 200px; text-align: right;">
                * äº¤æ˜“ï¼ˆæŠ¼é‡‘/æ”¶å…¥/èµ”ä»˜ï¼‰æš‚å­˜äºæ­¤ï¼Œè¯·æç°åˆ°é’±åŒ…ã€‚
            </div>
        </div>
    </div>

    <div class="card" style="border: 2px solid #ff9800;">
        <h2>ğŸšš ç‰©æµæ›´æ–°</h2>
        <div class="grid" style="grid-template-columns: 1fr 1fr 1fr auto;">
            <input id="logId" type="number" placeholder="ğŸ†” é±¼ ID">
            <input id="newLoc" placeholder="ğŸ“ å½“å‰ä½ç½®">
            <input id="newTemp" type="number" placeholder="ğŸŒ¡ï¸ å½“å‰æ¸©åº¦">
            <button class="logistics-btn" onclick="updateLogistics()">ğŸ“¦ æ›´æ–°çŠ¶æ€</button>
        </div>
        <p style="font-size:12px; color:#e65100; margin-top:-10px;">* æ¸©åº¦è¶…æ ‡å°†è‡ªåŠ¨æ ‡è®°å˜è´¨ã€‚</p>
    </div>

    <div class="card" style="border: 2px solid #e91e63;">
        <h2>ğŸª äº¤æ˜“å¸‚åœº (ä½¿ç”¨é±¼å¸) <button class="sm-btn" onclick="loadMarketplace()">ğŸ”„ åˆ·æ–°</button></h2>
        <div class="market-controls">
            <input type="text" id="marketSearch" placeholder="ğŸ” æœç´¢å“ç§..." oninput="renderMarketList()" style="flex:2">
            <select id="marketSort" onchange="renderMarketList()" style="flex:1">
                <option value="newest">ğŸ•’ æœ€æ–°</option>
                <option value="price_asc">â¬‡ï¸ ä»·æ ¼ä½â†’é«˜</option>
                <option value="price_desc">â¬†ï¸ ä»·æ ¼é«˜â†’ä½</option>
            </select>
        </div>
        <div class="scrollable-fish-container">
            <div id="marketList" class="fish-list"><p style="padding:20px;text-align:center;color:#999">åŠ è½½ä¸­...</p></div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ£ æ¸”æ°‘ï¼šæ•æ (Mint)</h2>
        <div class="grid">
            <input id="species" placeholder="ğŸŸ å“ç§">
            <input id="loc" placeholder="ğŸ“ åˆå§‹åœ°ç‚¹">
            <input id="temp" type="number" placeholder="ğŸŒ¡ï¸ åˆå§‹æ¸©åº¦">
            <input id="weight" type="number" placeholder="âš–ï¸ é‡é‡">
            <input id="maxTemp" type="number" placeholder="âš ï¸ å®‰å…¨æ¸©åº¦ä¸Šé™" style="border-color:#ff9800;">
        </div>
        <button onclick="catchFish()">ğŸŒŠ æ•æä¸Šé“¾</button>
    </div>

    <div class="card" style="border: 2px solid #e1f5fe;">
        <h2>ğŸ’ æˆ‘çš„é±¼ç¯“ <span style="font-size:14px;font-weight:normal;">(<span id="fishCount">0</span>)</span> <button class="sm-btn" onclick="loadMyFish()" style="float:right">ğŸ”„ åˆ·æ–°</button></h2>
        <div class="filter-tabs">
            <button class="filter-btn active" onclick="filterFish('all')">ğŸ“š å…¨éƒ¨</button>
            <button class="filter-btn" onclick="filterFish('private')">ğŸ”’ ç§æœ‰</button>
            <button class="filter-btn" onclick="filterFish('selling')">ğŸ’° åœ¨å”®</button>
            <button class="filter-btn" onclick="filterFish('sold')">ğŸ“¦ å¾…æ”¶è´§</button>
        </div>
        <div class="scrollable-fish-container">
            <div id="myFishList" class="fish-list"><p style="padding:20px;text-align:center;color:#999">è¯·è¿æ¥é’±åŒ…...</p></div>
        </div>
    </div>

    <div class="card">
        <h2>ğŸ’° å–å®¶ï¼šä¸Šæ¶æ“ä½œ (éœ€æˆæƒ)</h2>
        <div class="grid">
            <input id="sellId" type="number" placeholder="ğŸ†” é±¼ ID">
            <input id="sellPrice" type="number" placeholder="ğŸ’ å”®ä»· (FT)">
        </div>
        <button onclick="checkApproveAndList()" id="btnListAction">ğŸ·ï¸ æ£€æŸ¥æˆæƒå¹¶ä¸Šæ¶</button>
    </div>

    <div class="card" style="border-top: 4px solid #28a745;">
        <h2>ğŸ” æº¯æºæŸ¥è¯¢</h2>
        <div class="trace-tabs">
            <div class="trace-tab active" onclick="switchTraceMode('full')" id="tabFull">ğŸ“œ å…¨æµç¨‹æº¯æº</div>
            <div class="trace-tab" onclick="switchTraceMode('time')" id="tabTime">â±ï¸ æŒ‰æ—¶é—´ç‚¹æŸ¥å†·é“¾</div>
        </div>
        <div id="traceFullInput" style="display:flex; gap:10px; margin-bottom:15px;">
            <input id="queryId" type="number" placeholder="è¾“å…¥ ID æŸ¥è¯¢..." style="flex:1">
            <button onclick="getTraceInfo()" style="width:auto">ğŸ” è¿½æº¯</button>
        </div>
        <div id="traceTimeInput" style="display:none; gap:10px; margin-bottom:15px;">
            <input id="queryIdTime" type="number" placeholder="è¾“å…¥ ID" style="width:100px;">
            <input id="queryTime" type="datetime-local" style="flex:1">
            <button onclick="getTraceByTime()" style="width:auto">ğŸ“ æŸ¥è¯¢å¿«ç…§</button>
        </div>
        <div id="traceResult"></div>
    </div>

    <div id="status"></div>

    <script>
        // âš ï¸âš ï¸âš ï¸ è¯·æ›¿æ¢ä¸ºæœ€æ–°éƒ¨ç½²åˆçº¦åœ°å€ âš ï¸âš ï¸âš ï¸
        const CONTRACT_ADDRESS = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; 

        // ä¸»åˆçº¦ ABI
        const ABI = [
            "function token() view returns (address)", // è·å– Token åœ°å€
            "function catchFish(string, string, string, int256, uint256, string, int256) public returns (uint256)",
            "function listFish(uint256 tokenId, uint256 price) public", // ä¸å†æ˜¯ payable
            "function buyFish(uint256 tokenId) public", // ä¸å†æ˜¯ payable
            "function confirmReceipt(uint256 tokenId) public",
            "function rejectShipment(uint256 tokenId) public",
            "function withdrawPayments() public",
            "function updateLogistics(uint256 tokenId, string _location, int256 _temperature) public",
            "function getFishStatusAtTime(uint256 tokenId, uint256 queryTimestamp) view returns (string, int256, uint256, bool)",
            "function pendingWithdrawals(address) view returns (uint256)",
            "function fishDetails(uint256) view returns (string, string, int256, uint256, uint, string, uint256, uint8, address, address, int256, bool)",
            "function getFishByOwner(address) view returns (uint256[], tuple(string, string, int256, uint256, uint, string, uint256, uint8, address, address, int256, bool)[])",
            "function getAllFishForSale() view returns (uint256[], tuple(string, string, int256, uint256, uint, string, uint256, uint8, address, address, int256, bool)[])",
            "function getFishHistory(uint256) view returns (tuple(uint256 timestamp, string location, int256 temperature)[])",
            "function ownerOf(uint256) view returns (address)",
            "event FishCaught(uint256 indexed tokenId, address indexed fisherman, string species, int256 maxTemp)",
            "event FishListed(uint256 indexed tokenId, uint256 price, address seller)",
            "event FishSold(uint256 indexed tokenId, address buyer, uint256 price)",
            "event FishConfirmed(uint256 indexed tokenId, address buyer, address seller)",
            "event FishRejected(uint256 indexed tokenId, address buyer, address seller)"
        ];

        // é±¼å¸ Token ABI
        const TOKEN_ABI = [
            "function buyTokens() public payable",
            "function balanceOf(address) view returns (uint256)",
            "function approve(address spender, uint256 amount) public returns (bool)",
            "function allowance(address owner, address spender) view returns (uint256)"
        ];

        let provider, signer, contract, tokenContract;
        const STATE_TEXT = ["ç§æœ‰", "å‡ºå”®ä¸­", "å¾…æ”¶è´§", "å·²å®Œæˆ", "å·²æ‹’æ”¶"];
        let cachedMyFish = []; 
        let cachedMarketFish = []; 
        let currentFilter = 'all';

        async function connectWallet() {
            if (!window.ethereum) return alert("è¯·å®‰è£… MetaMask");
            try {
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                document.getElementById("walletAddress").innerText = await signer.getAddress();
                
                // åˆå§‹åŒ–ä¸»åˆçº¦
                contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
                
                // è·å– Token åœ°å€å¹¶åˆå§‹åŒ– Token åˆçº¦
                const tokenAddr = await contract.token();
                tokenContract = new ethers.Contract(tokenAddr, TOKEN_ABI, signer);

                document.getElementById("balanceSection").style.display = "block";
                document.getElementById("bankSection").style.display = "block";
                
                showToast("âœ… é’±åŒ…è¿æ¥æˆåŠŸ");
                refreshAll();
            } catch (e) { alert(e.message); }
        }

        // --- ğŸ¦ é“¶è¡Œä¸ä»£å¸é€»è¾‘ ---
        async function refreshBalances() {
            if(!contract || !tokenContract) return;
            try {
                const addr = await signer.getAddress();
                // 1. é’±åŒ…é‡Œçš„é±¼å¸
                const tokenBal = await tokenContract.balanceOf(addr);
                document.getElementById("myTokenBalance").innerText = ethers.formatEther(tokenBal) + " FT";
                
                // 2. åˆçº¦é‡Œå¾…æç°çš„é±¼å¸
                const pending = await contract.pendingWithdrawals(addr);
                document.getElementById("pendingBalance").innerText = ethers.formatEther(pending) + " FT";
            } catch(e) {}
        }

        async function buyTokens() {
            const amount = document.getElementById("buyTokenAmount").value;
            if(!amount) return alert("è¯·è¾“å…¥ ETH æ•°é‡");
            try {
                showToast("æ­£åœ¨å…‘æ¢é±¼å¸...");
                const tx = await tokenContract.buyTokens({ value: ethers.parseEther(amount) });
                await tx.wait();
                showToast("âœ… å…‘æ¢æˆåŠŸï¼");
                refreshBalances();
            } catch(e) { alert(e.message); }
        }

        // --- ğŸ” æ ¸å¿ƒï¼šäº¤æ˜“æˆæƒå¤„ç† ---
        // action: 'list' (1x) or 'buy' (2x)
        async function handleTokenAction(action, id, priceEth) {
            try {
                const price = ethers.parseEther(priceEth);
                const required = action === 'list' ? price : price * 2n;
                const addr = await signer.getAddress();

                // 1. æ£€æŸ¥æˆæƒ
                const allowance = await tokenContract.allowance(addr, CONTRACT_ADDRESS);
                if(allowance < required) {
                    if(!confirm(`âš ï¸ å°šæœªæˆæƒåˆçº¦æ‰£æ¬¾ã€‚\næœ¬æ¬¡æ“ä½œéœ€æ‰£é™¤: ${ethers.formatEther(required)} FT\nç‚¹å‡»ã€ç¡®å®šã€‘è¿›è¡Œæˆæƒã€‚`)) return;
                    showToast("æ­£åœ¨è¯·æ±‚æˆæƒ...");
                    // æˆæƒæœ€å¤§å€¼ï¼Œçœå¾—æ¯æ¬¡éƒ½è¦ç‚¹
                    const txApprove = await tokenContract.approve(CONTRACT_ADDRESS, ethers.MaxUint256);
                    await txApprove.wait();
                    showToast("âœ… æˆæƒæˆåŠŸï¼æ­£åœ¨æ‰§è¡Œäº¤æ˜“...");
                }

                // 2. æ‰§è¡Œäº¤æ˜“
                if(action === 'list') {
                    const tx = await contract.listFish(id, price);
                    await tx.wait();
                    showToast("âœ… ä¸Šæ¶æˆåŠŸ (å·²æ‰£æŠ¼é‡‘)");
                } else {
                    const tx = await contract.buyFish(id);
                    await tx.wait();
                    showToast("âœ… è´­ä¹°æˆåŠŸ (å·²æ‰£åŒå€èµ„é‡‘)");
                }
                refreshAll();

            } catch (e) { alert("äº¤æ˜“å¤±è´¥: " + (e.reason || e.message)); }
        }

        // --- ä¸šåŠ¡æ“ä½œ ---
        async function catchFish() {
            const s=v("species"), l=v("loc"), t=v("temp"), w=v("weight"), mt=v("maxTemp");
            if(!s||!l||!t||!w||!mt) return alert("è¯·å¡«å†™å®Œæ•´");
            try {
                showToast("ä¸Šé“¾ä¸­...");
                const tx = await contract.catchFish("ipfs://demo", s, l, t, w, "HASH_"+Date.now(), mt);
                await tx.wait();
                showToast("âœ… æ•ææˆåŠŸ");
                refreshAll();
            } catch(e) { alert(e.message); }
        }

        async function checkApproveAndList() {
            const id = v('sellId'), price = v('sellPrice');
            if(!id || !price) return alert("è¾“å…¥å®Œæ•´");
            await handleTokenAction('list', id, price);
        }

        async function buyFish(id, priceEth) {
            if(!confirm(`ç¡®è®¤è´­ä¹° ID:${id} ?\nå”®ä»·: ${priceEth} FT\néœ€ä»˜(å«æŠ¼é‡‘): ${priceEth*2} FT`)) return;
            await handleTokenAction('buy', id, priceEth);
        }

        async function confirmReceipt(id) {
            try { showToast("ç¡®è®¤æ”¶è´§..."); const tx = await contract.confirmReceipt(id); await tx.wait(); alert("èµ„é‡‘å·²ç»“ç®—"); refreshAll(); } catch(e) { alert(e.message); }
        }

        async function rejectShipment(id) {
            if(!confirm("âš ï¸ æ‹’æ”¶å°†æ²¡æ”¶å–å®¶æ‰€æœ‰èµ„é‡‘ï¼Œç¡®å®šå—ï¼Ÿ")) return;
            try { showToast("æ­£åœ¨æ‹’æ”¶..."); const tx = await contract.rejectShipment(id); await tx.wait(); alert("å·²æ‹’æ”¶èµ”ä»˜"); refreshAll(); } catch(e) { alert(e.message); }
        }

        async function withdrawPayments() {
            try { showToast("æç°ä¸­..."); const tx = await contract.withdrawPayments(); await tx.wait(); alert("é±¼å¸å·²æç°åˆ°é’±åŒ…"); refreshAll(); } catch(e) { alert(e.message); }
        }

        async function updateLogistics() {
            const id=v('logId'), l=v('newLoc'), t=v('newTemp');
            if(!id) return;
            try { showToast("æ›´æ–°ä¸­..."); const tx = await contract.updateLogistics(id, l, t); await tx.wait(); showToast("æ›´æ–°æˆåŠŸ"); refreshAll(); } catch(e){ alert(e.message); }
        }

        // --- æ•°æ®åŠ è½½ (å¸¦ Fish Token ä»·æ ¼å±•ç¤º) ---
        async function loadMyFish() {
            if (!contract) return;
            const div = document.getElementById("myFishList");
            div.innerHTML = "<p style='text-align:center'>åŠ è½½ä¸­...</p>";
            try {
                const addr = await signer.getAddress();
                const res = await contract.getFishByOwner(addr);
                const ids = res[0];
                const fishes = res[1];
                cachedMyFish = [];
                for(let i=0; i<ids.length; i++) {
                    cachedMyFish.push({ 
                        id: ids[i], data: fishes[i], state: Number(fishes[i][7]),
                        maxTemp: fishes[i][10], isSpoiled: fishes[i][11]
                    });
                }
                document.getElementById("fishCount").innerText = ids.length;
                renderFishList();
            } catch (e) { console.error(e); }
        }

        function renderFishList() {
            const div = document.getElementById("myFishList");
            div.innerHTML = "";
            const filtered = cachedMyFish.filter(item => {
                if (currentFilter === 'all') return true;
                if (currentFilter === 'private') return item.state === 0 || item.state === 3 || item.state === 4;
                if (currentFilter === 'selling') return item.state === 1;
                if (currentFilter === 'sold') return item.state === 2;
                return true;
            });
            if (filtered.length === 0) { div.innerHTML = "<p style='text-align:center;width:100%;color:#999'>æš‚æ— æ•°æ®</p>"; return; }

            filtered.forEach(item => {
                const {id, data: f, state, maxTemp, isSpoiled} = item;
                const price = ethers.formatEther(f[6]);
                const date = new Date(Number(f[4]) * 1000).toLocaleString();
                
                let actionHtml = "";
                if (state === 2) {
                    actionHtml = `
                        <button class="confirm-btn" onclick="event.stopPropagation(); confirmReceipt('${id}')">âœ… ç¡®è®¤æ”¶è´§</button>
                        <button class="reject-btn" onclick="event.stopPropagation(); rejectShipment('${id}')">âŒ æ‹’ç»æ”¶è´§</button>
                    `;
                }
                let spoiledHtml = isSpoiled ? `<div class="spoiled-alert">âš ï¸ å·²å˜è´¨ (> ${maxTemp}Â°C)</div>` : "";

                const card = document.createElement("div");
                card.className = "fish-card";
                card.innerHTML = `
                    <div class="fish-header"><h3 style="margin:0; color:#0077be;">ğŸŸ ${f[0]}</h3><span class="badge badge-${state}">${STATE_TEXT[state]}</span></div>
                    <div class="fish-details">
                        <p><span>ID:</span> <b>${id}</b></p>
                        <p><span>ğŸ“ åœ°ç‚¹:</span> ${f[1]}</p>
                        <p><span>ğŸŒ¡ï¸ æ¸©åº¦:</span> ${f[2]}Â°C</p>
                        <p><span>ğŸ’ ä»·æ ¼:</span> <b style="color:${state===0?'#999':'#f57f17'}">${state===0 ? '-' : price+' FT'}</b></p>
                    </div>
                    ${spoiledHtml}
                    ${actionHtml}
                `;
                card.onclick = () => { document.getElementById("sellId").value = id; document.getElementById("logId").value = id; };
                div.appendChild(card);
            });
        }

        async function loadMarketplace() {
            if (!contract) return;
            const div = document.getElementById("marketList");
            div.innerHTML = "<p style='text-align:center'>åŠ è½½ä¸­...</p>";
            try {
                const res = await contract.getAllFishForSale();
                const ids = res[0];
                const fishes = res[1];
                const myAddress = await signer.getAddress();
                cachedMarketFish = [];
                for (let i = 0; i < ids.length; i++) {
                    cachedMarketFish.push({
                        id: ids[i], data: fishes[i], species: fishes[i][0],
                        priceWei: fishes[i][6], seller: fishes[i][8],
                        isMine: fishes[i][8].toLowerCase() === myAddress.toLowerCase()
                    });
                }
                renderMarketList();
            } catch (e) { div.innerHTML = "<p>åŠ è½½å¤±è´¥</p>"; }
        }

        function renderMarketList() {
            const div = document.getElementById("marketList");
            div.innerHTML = "";
            const searchTerm = document.getElementById("marketSearch").value.toLowerCase();
            const sortType = document.getElementById("marketSort").value;
            let filtered = cachedMarketFish.filter(item => item.species.toLowerCase().includes(searchTerm));
            filtered.sort((a, b) => {
                if (sortType === 'price_asc') return a.priceWei < b.priceWei ? -1 : 1;
                else if (sortType === 'price_desc') return a.priceWei > b.priceWei ? -1 : 1;
                else return b.id < a.id ? -1 : 1;
            });
            if (filtered.length === 0) { div.innerHTML = "<p style='text-align:center;width:100%;color:#999'>æš‚æ— å•†å“</p>"; return; }
            filtered.forEach(item => {
                const { id, data: f, priceWei, isMine } = item;
                const priceEth = ethers.formatEther(priceWei);
                let btnHtml = isMine 
                    ? `<button disabled style="background:#ccc;">ğŸš« æ‚¨çš„å•†å“</button>` 
                    : `<button class="buy-btn" onclick="buyFish('${id}', '${priceEth}')">ğŸ›’ è´­ä¹°</button>`;
                
                const card = document.createElement("div");
                card.className = "fish-card";
                card.style.borderColor = "#e91e63";
                card.innerHTML = `
                    <div class="fish-header"><h3 style="margin:0; color:#e91e63;">ğŸŸ ${f[0]}</h3><span class="badge" style="background:#fce4ec; color:#c2185b">ğŸ”¥ ID: ${id}</span></div>
                    <div class="fish-details">
                        <p><span>ğŸ“ åœ°ç‚¹:</span> <b>${f[1]}</b></p>
                        <p><span>âš–ï¸ é‡é‡:</span> <b>${f[3]} g</b></p>
                        <p><span>ğŸ‘¤ å–å®¶:</span> ${shortAddr(f[8])}</p>
                        <p><span>ğŸ’ å”®ä»·:</span> <b style="color:#e91e63; font-size:1.1em">${priceEth} FT</b></p>
                    </div>
                    ${btnHtml}
                `;
                div.appendChild(card);
            });
        }

        // --- æº¯æº (å¤ç”¨ä¸Šä¸€ç‰ˆé€»è¾‘ï¼Œæ— éœ€å˜åŠ¨) ---
        async function getTraceInfo() { /* ...ä»£ç çœç•¥ï¼Œé€»è¾‘åŒä¸Šä¸€ç‰ˆï¼Œåªéœ€æ³¨æ„ä»·æ ¼å•ä½å˜äº†... */ }
        async function getTraceByTime() { /* ...åŒä¸Š... */ }
        // ä¸ºäº†å®Œæ•´æ€§ï¼Œè¿™é‡Œæ”¾ç®€ç‰ˆ:
        async function getTraceInfo() {
             if (!contract) return;
             const id = document.getElementById("queryId").value;
             if(!id) return;
             const div = document.getElementById("traceResult");
             div.innerHTML = "æŸ¥è¯¢ä¸­...";
             try {
                 const info = await contract.fishDetails(id);
                 const history = await contract.getFishHistory(id);
                 let hHtml = "";
                 history.forEach(h => { hHtml += `<div>${new Date(Number(h.timestamp)*1000).toLocaleString()} - ${h.location} (${h.temperature}Â°C)</div>`; });
                 div.innerHTML = `<div style="background:#fff;padding:10px;"><h3>${info[0]}</h3>${hHtml}</div>`;
             } catch(e) { div.innerHTML = "æŸ¥è¯¢å¤±è´¥"; }
        }
        async function getTraceByTime() {
            const id = document.getElementById("queryIdTime").value;
            const timeStr = document.getElementById("queryTime").value;
            if(!id||!timeStr) return;
            const ts = Math.floor(new Date(timeStr).getTime()/1000);
            try {
                const res = await contract.getFishStatusAtTime(id, ts);
                document.getElementById("traceResult").innerHTML = res[3] ? `<div>${res[0]}, ${res[1]}Â°C</div>` : "æœªæ‰¾åˆ°";
            } catch(e){}
        }

        function v(id) { return document.getElementById(id).value; }
        function shortAddr(addr) { return addr ? addr.slice(0,6)+"..."+addr.slice(-4) : ""; }
        function refreshAll() { clearInputs(); refreshBalances(); loadMyFish(); loadMarketplace(); }
        function clearInputs() { document.querySelectorAll("input").forEach(i => i.value = ""); }
        function showToast(msg) { const el = document.getElementById("status"); el.innerText = msg; el.style.display = "block"; setTimeout(() => el.style.display = "none", 3000); }
    </script>
</body>
</html>